---
- name: Allow all traffic on virbr0
  become: true
  community.general.ufw:
    rule: allow
    interface_in: virbr0
- name: Allow forwarding to virbr0
  become: true
  community.general.ufw:
    rule: allow
    route: true
    interface_in: virbr0
    interface_out: "{{ ansible_default_ipv4.interface }}"
- name: List existing libvirt domains
  become: true
  community.libvirt.virt:
    command: list_vms
  register: vm_list
  changed_when: false
- name: Define vps
  become: true
  community.libvirt.virt:
    name: "{{ recipe_vps_name }}"
    command: define
    xml: "{{ lookup('template', 'recipe_vps.xml.j2') }}"
  when: recipe_vps_name not in (vm_list.list_vms | default([]))
- name: Ensure vm is running
  become: true
  community.libvirt.virt:
    name: "{{ recipe_vps_name }}"
    state: running
    autostart: true
