---
- name: Allow all traffic on virbr0
  become: true
  community.general.ufw:
    rule: allow
    interface_in: virbr0
- name: Allow forwarding to virbr0
  become: true
  community.general.ufw:
    rule: allow
    route: true
    interface_in: virbr0
    interface_out: "{{ ansible_default_ipv4.interface }}"
- name: List existing libvirt domains
  become: true
  community.libvirt.virt:
    command: list_vms
  register: vm_list
  changed_when: false
- name: Define vms
  become: true
  community.libvirt.virt:
    name: "{{ item }}"
    command: define
    xml: "{{ lookup('template', item ~ '.xml.j2') }}"
  loop: "{{ defined_vms }}"
  when: item not in (vm_list.list_vms | default([]))
- name: Autostart vms
  become: true
  community.libvirt.virt:
    name: "{{ item }}"
    state: running
    autostart: true
  loop: "{{ defined_vms }}"
